import{X as a,l as m}from"./mainRouter-D1MtaxKQ.js";const B=c=>{if(!c)return"";const u={year:"numeric",month:"long",day:"numeric"};return new Date(c).toLocaleDateString(void 0,u)};let g=null;const y=async()=>{console.log("Fetching user...");const{data:{user:c},error:u}=await a.auth.getUser();return u?(console.error("Error fetching user:",u),null):(g=c,g)};y();const G=()=>{const c=m([]),u=m(!1),h=m(!1),i=m(null),b=async r=>{const{data:e}=await a.from("extracted_content").select("extracted_text").eq("id",r).single();return e==null?void 0:e.extracted_text},E=async()=>{console.log("fetching Categories");const{data:r,error:e}=await a.from("categories").select("*");return e&&console.error("Category fetch error:",e),r||[]},x=async()=>{console.log("fetching SubCategories");const{data:r,error:e}=await a.from("sub_categories").select("*");return e&&console.error("Sub-category fetch error:",e),console.log("Fetched sub categories: ",r.length),r||[]},w=async()=>{console.log("fetching saved contexts");const{data:r,error:e}=await a.from("extracted_content").select("*").order("extracted_at",{ascending:!1});if(e){console.error("fetchSavedContexts error:",i);return}return console.log("Fetched context records: ",r.length),r},C=async(r,e)=>{console.log("fetching saved contexts with filter...");let t=a.from("extracted_content").select(`
    *,
    categories(name),
    sub_categories(name)
  `);r&&(t=t.eq("category_id",r)),e&&(t=t.eq("sub_category_id",e)),t=t.order("extracted_at",{ascending:!1});const{data:s,error:o}=await t;return o?(console.error("Fetch error:",o),null):s},U=async(r,e,t,s,o)=>{console.log("Extracting and saving content (URL): "+r),console.log("Extracting and saving content (Category): "+s),console.log("Extracting and saving content (SubCategory): "+o);const{data:l,error:n}=await a.from("extracted_content").insert({user_id:g.id,original_url:r,extracted_text:e,text_size_bytes:t,url_last_modified:new Date().toISOString(),category_id:s,sub_category_id:o||null,metadata:{source_type:"web_page",extraction_method:"dom_parser"}}).select();return n?(console.error("Error saving content: "+JSON.stringify(n)),null):await w()},k=async r=>{try{const{data:e}=await a.from("blog_posts").select("likes").eq("id",r).single(),t=(e==null?void 0:e.likes)||0,{data:s,error:o}=await a.from("blog_posts").update({likes:t+1}).eq("id",r).select("likes").single();if(o)throw o;const l=c.value.findIndex(n=>n.id===r);return l!==-1&&(c.value[l]={...c.value[l],likes:s.likes}),s}catch(e){console.error("Error liking post:",e),i.value=e.message}},_=async r=>{try{const{data:e,error:t}=await a.from("blog_posts").select("*").eq("id",r).single();if(t)throw t;return e}catch(e){return console.error("Error fetching post:",e),i.value=e.message,null}},P=async r=>{console.log("Deleting post for iD: ",r);const e=await _(r);if(!e)return;const t=e.image_url;console.log("Checking if other posts use the same image");const{data:s,error:o}=await a.from("blog_posts").select("image_url").eq("image_url",t).neq("id",r);if(o){console.error("Error checking image usage:",o);return}if(console.log("Number of other posts using the same image: ",s.length),s.length===0&&t){console.log("No other posts use the same image so deleting it...");const{error:n}=await a.storage.from("images/public").remove([t]);n&&console.error("Error deleting image:",n)}const{error:l}=await a.from("blog_posts").delete().eq("id",r);if(l){console.error("Error deleting post:",l);return}c.value=c.value.filter(n=>n.id!==r)},q=async(r,e,t,s,o,l,n,d,p)=>{console.log("Creating post with title: "+r),console.log("content "+e),console.log("category "+o),console.log("author "+l),console.log("language "+n),console.log("translationAvailable "+d),console.log("translatedLanguage "+p);try{const{data:f,error:v}=await a.from("blog_posts").insert([{title:r,content:e,image_url:t||"",styles:s,likes:0,category:o,author:l,language:n,translation_available:!!d,translation_language:p||"japanese"}]).select().single();if(v)throw v;return c.value.unshift(f),f}catch(f){return console.error("Error creating post:",f),i.value=f.message,null}},D=async r=>{try{const{data:e,error:t}=await a.from("blog_posts").select("linked_post_id").eq("id",r).single();if(t)throw t;return e.linked_post_id}catch(e){return console.error("Error fetching translated post ID:",e),i.value=e.message,null}},S=async()=>{console.log("fetching posts...");try{u.value=!0;const{data:r,error:e}=await a.from("blog_posts").select("*").order("created_at",{ascending:!1});if(e)throw e;return c.value=r,r}catch(r){return console.error("Error fetching posts:",r),i.value=r.message,null}finally{u.value=!1}},I=async(r,e,t,s)=>{console.log("Updating linked post with title: "+r),console.log("postId: "+e),console.log("translation_language: "+t),console.log("translation_available: "+s);try{const{data:o,error:l}=await a.from("blog_posts").update({linked_post_id:e,translation_language:t}).eq("id",r).select().single();if(l)throw l;const n=c.value.findIndex(d=>d.id===r);return n!==-1&&(c.value[n]=o),o}catch(o){return console.error("Error updating linked post:",o),i.value=o.message,null}},L=async(r,e,t,s)=>{console.log("Updating post with title: "+e),console.log("postId: "+r),console.log("category: "+t),console.log("content: "+s);try{const{data:o,error:l}=await a.from("blog_posts").update({title:e,category:t,content:s}).eq("id",r).select().single();if(l)throw l;const n=c.value.findIndex(d=>d.id===r);return n!==-1&&(c.value[n]=o),o}catch(o){return console.error("Error updating post:",o),i.value=o.message,null}},O=async(r,e,t)=>{try{const{data:s,error:o}=await a.from("blog_posts").insert([{title:`Translated Post of ${r}`,content:e,linked_post_id:r,translation_language:t,translation_available:!0}]).select().single();if(o)throw o;return s}catch(s){return console.error("Error publishing translated post:",s),i.value=s.message,null}},R=async r=>{const{data:e,error:t}=await a.storage.from("images").update(`${r.name}`,r,{cacheControl:"3600",upsert:!0});return t&&(i.value=t.message),e.path},A=async r=>{const{data:e,error:t}=await a.storage.from("images/public").upload(r.name,r);return t?(console.error("Error uploading image:",t),null):e.path},F=async r=>{try{const{data:e,error:t}=await a.storage.from("images/public/").download(r);if(t)throw t;return URL.createObjectURL(e)}catch(e){return console.error("Error downloading image:",e),console.log("Problem with image path:",r),i.value=e.message,null}},N=async r=>{if(!r.id){i.value="Pass a user ID to update the profile";return}try{u.value=!0;let{error:e}=await a.from("profiles").upsert(r);if(e)throw e}catch(e){e.value=e.message}finally{u.value=!1}},W=async(r,e,t)=>{console.log("addComment content: "+e),console.log("addComment username: "+t);const s="5e02ab47-4fd4-4620-8ce0-e6b73021b8f9";if(console.log("guestUserID: "+s),!r)throw"No postId provided";if(!e)throw"No content provided";let o=s,l=!1;g&&(o=g.id,l=!0);try{const{data:n,error:d}=await a.from("comments").insert([{post_id:r,user_id:o,content:e,username:t,approved:l}]).select().single();if(d)throw d;return n}catch(n){return console.error("Error adding comment:",n),i.value=n.message,null}},j=async r=>{try{h.value=!0;const{data:e,error:t}=await a.from("comments").select("*").eq("post_id",r).eq("approved",!0).order("created_at",{ascending:!0});if(t)throw t;return e}catch(e){return console.error("Error fetching comments:",e),i.value=e.message,[]}finally{h.value=!1}},T=async r=>{try{const{data:e,error:t}=await a.storage.from("avatars").download(r);if(t)throw t;return URL.createObjectURL(e)}catch(e){return console.error("Error downloading avatar: ",e.message),null}};async function $(){if(!g||!g.id){const t=await y();if(!t||!t.id)return null;g=t}let{data:r,error:e}=await a.from("profiles").select("username, website, avatar_url").eq("id",g.id).single();return e?(e.value=e.message,null):r}async function z(){try{u.value=!0;let{error:r}=await a.auth.signOut();return!0}catch(r){return r.value=r.message,!1}finally{u.value=!1}}return{posts:c,loading:u,commentsLoading:h,error:i,user:g,fetchCategories:E,fetchSubCategories:x,fetchSavedContextsWithFilter:C,getContextByID:b,fetchSavedContexts:w,saveContextData:U,updateLinkedPost:I,signInWithEmailAndPassword:async(r,e)=>{const{data:t,error:s}=await a.auth.signInWithPassword({email:r,password:e});return s?(console.error("Error signing in: ",s.message),!1):!0},uploadImage:A,uploadReplaceImage:R,downloadImage:F,fetchPosts:S,getPost:_,createPost:q,updatePost:L,publishTranslatedPost:O,getTranslatedPostId:D,addComment:W,getComments:j,likePost:k,signOut:z,formatDate:B,getSignedInUserProfile:$,isUserSignedIn:()=>g!==null,getSignedInUser:()=>g,downloadUserAvatar:T,updateUserProfile:N,deletePost:P}};export{G as u};
