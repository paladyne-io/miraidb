import{X as a,l as m}from"./mainRouter-D1MtaxKQ.js";const T=i=>{if(!i)return"";const u={year:"numeric",month:"long",day:"numeric"};return new Date(i).toLocaleDateString(void 0,u)};let g=null;const E=async()=>{if(console.log("Fetching user..."),g)return console.log("User already fetched"),g;const{data:{user:i},error:u}=await a.auth.getUser();return u?(console.error("Error fetching user:",u),null):(g=i,console.log("Returning user..."),g)};E();const F=()=>{const i=m([]),u=m(!1),p=m(!1),c=m(null),_=async r=>{try{const{data:e}=await a.from("blog_posts").select("likes").eq("id",r).single(),o=(e==null?void 0:e.likes)||0,{data:t,error:s}=await a.from("blog_posts").update({likes:o+1}).eq("id",r).select("likes").single();if(s)throw s;const l=i.value.findIndex(n=>n.id===r);return l!==-1&&(i.value[l]={...i.value[l],likes:t.likes}),t}catch(e){console.error("Error liking post:",e),c.value=e.message}},w=async r=>{try{const{data:e,error:o}=await a.from("blog_posts").select("*").eq("id",r).single();if(o)throw o;return e}catch(e){return console.error("Error fetching post:",e),c.value=e.message,null}},b=async r=>{console.log("Deleting post for iD: ",r);const e=await w(r);if(!e)return;const o=e.image_url;console.log("Checking if other posts use the same image");const{data:t,error:s}=await a.from("blog_posts").select("image_url").eq("image_url",o).neq("id",r);if(s){console.error("Error checking image usage:",s);return}if(console.log("Number of other posts using the same image: ",t.length),t.length===0&&o){console.log("No other posts use the same image so deleting it...");const{error:n}=await a.storage.from("images/public").remove([o]);n&&console.error("Error deleting image:",n)}const{error:l}=await a.from("blog_posts").delete().eq("id",r);if(l){console.error("Error deleting post:",l);return}i.value=i.value.filter(n=>n.id!==r)},k=async(r,e,o,t,s,l,n,d,v,h)=>{console.log("Creating post with title: "+r),console.log("content "+e),console.log("category "+s),console.log("author "+l),console.log("language "+d),console.log("linkedPostID :"+n),console.log("translationAvailable "+v),console.log("translatedLanguage "+h);try{const{data:f,error:y}=await a.from("blog_posts").insert([{title:r,content:e,image_url:o||"",styles:t,likes:0,category:s,author:l,language:d,linked_post_id:n,translation_available:!!v,translation_language:h||"japanese"}]).select().single();if(y)throw y;return i.value.unshift(f),f}catch(f){return console.error("Error creating post:",f),c.value=f.message,null}},U=async r=>{try{const{data:e,error:o}=await a.from("blog_posts").select("linked_post_id").eq("id",r).single();if(o)throw o;return e.linked_post_id}catch(e){return console.error("Error fetching translated post ID:",e),c.value=e.message,null}},P=async()=>{try{u.value=!0;const{data:r,error:e}=await a.from("blog_posts").select("*").order("created_at",{ascending:!1});if(e)throw e;return i.value=r,r}catch(r){return console.error("Error fetching posts:",r),c.value=r.message,null}finally{u.value=!1}},I=async(r,e,o,t)=>{if(console.log("Updating linked post with postId: "+r),console.log("linkedPostID: "+e),console.log("translation_language: "+o),console.log("translation_available: "+t),!e)return console.error("Error updating linked post. No post ID provided"),c.value=err.message,null;try{const{data:s,error:l}=await a.from("blog_posts").update({linked_post_id:e,translation_language:o,translation_available:t}).eq("id",r).select().single();if(l)throw l;const n=i.value.findIndex(d=>d.id===r);return n!==-1&&(i.value[n]=s),console.log("Returning new post data"),s}catch(s){return console.error("Error updating linked post:",s),c.value=s.message,null}},q=async(r,e,o,t)=>{console.log("Updating post with title: "+e),console.log("postId: "+r),console.log("category: "+o),console.log("content: "+t);try{const{data:s,error:l}=await a.from("blog_posts").update({title:e,category:o,content:t}).eq("id",r).select().single();if(l)throw l;const n=i.value.findIndex(d=>d.id===r);return n!==-1&&(i.value[n]=s),s}catch(s){return console.error("Error updating post:",s),c.value=s.message,null}},D=async(r,e,o)=>{try{const{data:t,error:s}=await a.from("blog_posts").insert([{title:`Translated Post of ${r}`,content:e,linked_post_id:r,translation_language:o,translation_available:!0}]).select().single();if(s)throw s;return t}catch(t){return console.error("Error publishing translated post:",t),c.value=t.message,null}},x=async r=>{const{data:e,error:o}=await a.storage.from("images").update(`${r.name}`,r,{cacheControl:"3600",upsert:!0});return o&&(c.value=o.message),e.path},C=async(r,e=!0)=>{const{data:o,error:t}=await a.storage.from("images/public").upload(r.name,r);if(t){if(console.error("Error uploading image:",t),t.error==="Duplicate"){if(console.log("Duplicate image - will use existing: "+e),e)return r.name;t.value="Image already exists"}return null}return o.path},L=async r=>{try{const{data:e,error:o}=await a.storage.from("images/public/").download(r);if(o)throw o;return URL.createObjectURL(e)}catch(e){return console.error("Error downloading image:",e),console.log("Problem with image path:",r),c.value=e.message,null}},R=async r=>{if(!r.id){c.value="Pass a user ID to update the profile";return}try{u.value=!0;let{error:e}=await a.from("profiles").upsert(r);if(e)throw e}catch(e){e.value=e.message}finally{u.value=!1}},A=async(r,e,o)=>{console.log("addComment content: "+e),console.log("addComment username: "+o);const t="5e02ab47-4fd4-4620-8ce0-e6b73021b8f9";if(console.log("guestUserID: "+t),!r)throw"No postId provided";if(!e)throw"No content provided";let s=t,l=!1;g&&(s=g.id,l=!0);try{const{data:n,error:d}=await a.from("comments").insert([{post_id:r,user_id:s,content:e,username:o,approved:l}]).select().single();if(d)throw d;return n}catch(n){return console.error("Error adding comment:",n),c.value=n.message,null}},N=async r=>{try{p.value=!0;const{data:e,error:o}=await a.from("comments").select("*").eq("post_id",r).eq("approved",!0).order("created_at",{ascending:!0});if(o)throw o;return e}catch(e){return console.error("Error fetching comments:",e),c.value=e.message,[]}finally{p.value=!1}},S=async r=>{try{const{data:e,error:o}=await a.storage.from("avatars").download(r);if(o)throw o;return URL.createObjectURL(e)}catch(e){return console.error("Error downloading avatar: ",e.message),null}},O=async()=>{if(!g){console.log("getSignedInUserProfile no user...");const o=await E();if(!o||!o.id)return null;g=o}let{data:r,error:e}=await a.from("profiles").select("username, website, avatar_url").eq("id",g.id).single();return e?(e.value=e.message,null):r};async function j(){try{u.value=!0;let{error:r}=await a.auth.signOut();return!0}catch(r){return r.value=r.message,!1}finally{u.value=!1}}return{posts:i,loading:u,commentsLoading:p,error:c,user:g,updateLinkedPost:I,signInWithEmailAndPassword:async(r,e)=>{const{data:o,error:t}=await a.auth.signInWithPassword({email:r,password:e});return t?(console.error("Error signing in: ",t.message),!1):!0},uploadImage:C,uploadReplaceImage:x,downloadImage:L,fetchPosts:P,getPost:w,createPost:k,updatePost:q,publishTranslatedPost:D,getTranslatedPostId:U,addComment:A,getComments:N,likePost:_,signOut:j,formatDate:T,getSignedInUserProfile:O,isUserSignedIn:()=>g!==null,getSignedInUser:()=>g,downloadUserAvatar:S,updateUserProfile:R,deletePost:b}};export{F as u};
